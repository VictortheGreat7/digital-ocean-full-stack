apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k6-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    prometheus: kube-prometheus
spec:
  groups:
    - name: k6.critical
      interval: 30s
      rules:
        - alert: ChaosErrorRateCritical
          expr: |
            rate(k6_http_req_failed[5m]) / clamp_min(rate(k6_http_reqs[5m]), 1) > 0.10
          for: 2m
          labels:
            severity: critical
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 load test error rate exceeds 10%
            description: "Error rate is {{ `{{ $value | humanizePercentage }}` }} for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Check the k6 load test results for high error rates.
              2. Investigate application logs for errors.
              3. Scale up application resources if necessary.
              4. Rerun the load test after addressing issues.

        - alert: ChaosCompleteFailure
          expr: |
            rate(k6_http_req_failed[2m]) / clamp_min(rate(k6_http_reqs[2m]), 1) > 0.90
          for: 1m
          labels:
            severity: critical
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 test >90% failure rate 
            description: "{{ `{{ $value | humanizePercentage }}` }} of requests failing for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Immediately check application status and logs.
              2. Identify and resolve critical issues causing high failure rate.
              3. Consider rolling back recent deployments if needed.
              4. Notify team and stakeholders.

    - name: k6.warning
      interval: 30s
      rules:
        - alert: K6ErrorRateHigh
          expr: |
            rate(k6_http_req_failed[5m]) / clamp_min(rate(k6_http_reqs[5m]), 1) > 0.05
          for: 3m
          labels:
            severity: warning
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 error rate exceeds 5%
            description: "Error rate is {{ `{{ $value | humanizePercentage }}` }} for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Review k6 load test results for error trends.
              2. Check logs for 4xx/5xx errors.
              3. Optimize application performance and error handling.
              4. Rerun load tests to verify improvements.

        - alert: K6P99LatencyHigh
          expr: |
            histogram_quantile(0.99, sum(rate(k6_http_req_duration[5m])) by (le, name)) > 1
          for: 3m
          labels:
            severity: warning
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 p99 latency exceeds 1000ms
            description: "P99 latency is {{ `{{ $value }}` }}s for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Analyze k6 load test results for latency.
              2. Profile performance to find bottlenecks.
              3. Optimize DB queries, caching, and code.
              4. Rerun load tests to validate improvements.

        - alert: K6P95LatencyHigh
          expr: |
            histogram_quantile(0.95, sum(rate(k6_http_req_duration[5m])) by (le, name)) > 0.5
          for: 3m
          labels:
            severity: warning
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 p95 latency exceeds 500ms
            description: "P95 latency is {{ `{{ $value }}` }}s for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Check k6 latency patterns.
              2. Investigate application components contributing to high latency.
              3. Apply performance improvements.
              4. Rerun load tests to validate results.

        - alert: K6P50LatencyElevated
          expr: |
            histogram_quantile(0.50, sum(rate(k6_http_req_duration[5m])) by (le, name)) > 0.2
          for: 5m
          labels:
            severity: info
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 median latency exceeds 200ms
            description: "Median latency is {{ `{{ $value }}` }}s for test type: {{ `{{ $labels.test_type }}` }}"
            runbook: |
              1. Monitor median latency trends.
              2. Identify changes affecting performance.
              3. Apply minor optimizations.
              4. Continue monitoring subsequent tests.

    - name: k6.performance
      interval: 30s
      rules:
        - alert: K6ThroughputDrop
          expr: |
            rate(k6_http_reqs[5m]) < 10
          for: 5m
          labels:
            severity: warning
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 throughput <10 req/s
            description: "Current throughput: {{ `{{ $value }}` }} RPS for test type: {{ `{{ $labels.test_type }}` }}"

        - alert: K6IterationRateLow
          expr: |
            rate(k6_iterations[5m]) < 5
          for: 5m
          labels:
            severity: info
            test_type: "{{ `{{ $labels.test_type }}` }}"
          annotations:
            summary: K6 iteration rate <5 it/s
            description: "Current iteration rate: {{ `{{ $value }}` }} it/s for test type: {{ `{{ $labels.test_type }}` }}"
