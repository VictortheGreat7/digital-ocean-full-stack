apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k6-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    prometheus: kube-prometheus
spec:
  groups:

  - name: k6.critical
    interval: 30s
    rules:
    - alert: K6ErrorRateCritical
      expr: |
        rate(k6_http_req_failed_total[5m])
        /
        clamp_min(rate(k6_http_reqs_total[5m]), 1)
        > 0.10
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "K6 error rate exceeds 10%"
        description: "Error rate is {{ $value | humanizePercentage }}"
        runbook: |
          1. Inspect k6 error metrics
          2. Check application logs
          3. Scale or rollback if needed

    - alert: K6CompleteFailure
      expr: |
        rate(k6_http_req_failed_total[2m])
        /
        clamp_min(rate(k6_http_reqs_total[2m]), 1)
        > 0.90
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "K6 test showing >90% failure rate"
        description: "{{ $value | humanizePercentage }} of requests are failing"
        runbook: |
          1. Treat as outage
          2. Inspect service health immediately
          3. Roll back recent changes

  - name: k6.warning
    interval: 30s
    rules:
    - alert: K6ErrorRateHigh
      expr: |
        rate(k6_http_req_failed_total[5m])
        /
        clamp_min(rate(k6_http_reqs_total[5m]), 1)
        > 0.05
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "K6 error rate exceeds 5%"
        description: "Error rate is {{ $value | humanizePercentage }}"

    - alert: K6P99LatencyHigh
      expr: |
        histogram_quantile(
          0.99,
          sum(rate(k6_http_req_duration_seconds_bucket[5m])) by (le)
        ) > 1
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "K6 p99 latency exceeds 1s"
        description: "p99 latency is {{ $value }}s"

    - alert: K6P95LatencyHigh
      expr: |
        histogram_quantile(
          0.95,
          sum(rate(k6_http_req_duration_seconds_bucket[5m])) by (le)
        ) > 0.5
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "K6 p95 latency exceeds 500ms"
        description: "p95 latency is {{ $value }}s"

    - alert: K6P50LatencyElevated
      expr: |
        histogram_quantile(
          0.50,
          sum(rate(k6_http_req_duration_seconds_bucket[5m])) by (le)
        ) > 0.2
      for: 5m
      labels:
        severity: info
      annotations:
        summary: "K6 p50 latency exceeds 200ms"
        description: "p50 latency is {{ $value }}s"

  - name: k6.performance
    interval: 30s
    rules:
    - alert: K6ThroughputDrop
      expr: |
        rate(k6_http_reqs_total[5m]) < 10
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "K6 throughput below 10 req/s"
        description: "Throughput is {{ $value }} req/s"

    - alert: K6IterationRateLow
      expr: |
        rate(k6_iterations_total[5m]) < 5
      for: 5m
      labels:
        severity: info
      annotations:
        summary: "K6 iteration rate low"
        description: "Iteration rate is {{ $value }} it/s"

  - name: k6.load-generator
    interval: 30s
    rules:
    - alert: K6LoadGeneratorNotRunning
      expr: |
        absent(k6_http_reqs_total)
        OR
        rate(k6_http_reqs_total[2m]) < 0.001
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "K6 load generator not sending traffic"
        description: "No requests detected from k6"

    - alert: K6VUCountUnexpected
      expr: |
        k6_vus == 0
        AND
        k6_vus_max > 0
      for: 5m
      labels:
        severity: info
      annotations:
        summary: "K6 has zero active VUs"
        description: "Configured VUs exist but none are running"

    - alert: K6LoadGeneratorCPUHigh
      expr: |
        rate(container_cpu_usage_seconds_total{pod=~"k6-.*"}[5m]) > 1.8
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "K6 load generator CPU high"
        description: "CPU usage is {{ $value }} cores"

  - name: k6.slo
    interval: 30s
    rules:
    - alert: K6AvailabilitySLOViolated
      expr: |
        1 -
        (
          rate(k6_http_req_failed_total[10m])
          /
          clamp_min(rate(k6_http_reqs_total[10m]), 1)
        )
        < 0.999
      for: 5m
      labels:
        severity: critical
        slo: availability
      annotations:
        summary: "Availability SLO (99.9%) violated"
        description: "Availability is {{ $value | humanizePercentage }}"

    - alert: K6LatencySLOViolated
      expr: |
        histogram_quantile(
          0.95,
          sum(rate(k6_http_req_duration_seconds_bucket[10m])) by (le)
        ) > 0.5
      for: 5m
      labels:
        severity: critical
        slo: latency
      annotations:
        summary: "Latency SLO violated"
        description: "p95 latency is {{ $value }}s"

  - name: k6.recording
    interval: 1m
    rules:
    - record: k6:http:error_rate
      expr: |
        rate(k6_http_req_failed_total[5m])
        /
        clamp_min(rate(k6_http_reqs_total[5m]), 1)

    - record: k6:http:latency:p95
      expr: |
        histogram_quantile(
          0.95,
          sum(rate(k6_http_req_duration_seconds_bucket[5m])) by (le)
        )
